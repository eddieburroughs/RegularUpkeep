  name: Deploy to Production

  on:
    push:
      branches:
        - main
    workflow_dispatch:

  jobs:
    deploy:
      runs-on: ubuntu-latest
      name: Deploy to Production Server

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Deploy via SSH
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.SERVER_SSH_KEY }}
            port: ${{ secrets.SERVER_PORT }}
            script: |
              cd /root/RegularUpkeep-app
              git pull origin main
              ./scripts/deploy.sh

        - name: Notify on Success
          if: success()
          run: echo "Deployment successful!"

        - name: Notify Slack on Failure
          if: failure()
          run: |
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"ðŸš¨ Deployment Failed\nRepo: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
              "${{ secrets.SLACK_WEBHOOK_URL }}"                                                                                                                     
                  }                                                                                                                       
                ]                                                                                                                         
              }' \                                                                                                                        
              "$SLACK_WEBHOOK_URL"
